import streamlit as st

import pandas as pd

import numpy as np

import scipy.stats as stats

import statsmodels.api as sm

import statsmodels.formula.api as smf

from statsmodels.stats.multicomp import pairwise_tukeyhsd

from statsmodels.stats.power import TTestIndPower

from lifelines import KaplanMeierFitter, CoxPHFitter

from sklearn.metrics import roc_curve, auc, confusion_matrix, classification_report

from sklearn.impute import SimpleImputer

import plotly.express as px

import plotly.graph_objects as go

import plotly.figure_factory as ff

import matplotlib.pyplot as plt

import seaborn as sns

import base64

import io

from datetime import datetime

import time

import random

from docx import Document

from docx.shared import Inches, Pt

from docx.enum.text import WD_ALIGN_PARAGRAPH

from fpdf import FPDF

import tempfile

import os

# ==========================================

# CONFIGURATION & GLOBAL STYLES

# ==========================================

st.set_page_config(

Â  Â  page_title="MedStat Pro | Powerhouse Research Suite",

Â  Â  page_icon="âš•ï¸",

Â  Â  layout="wide",

Â  Â  initial_sidebar_state="expanded"

)

APP_NAME = "MedStat Pro"

VERSION = "3.1 (PDF Support)"

# Custom CSS for Professional UI

st.markdown("""

""", unsafe_allow_html=True)

# ==========================================

# SESSION STATE INITIALIZATION

# ==========================================

if 'df' not in st.session_state: st.session_state.df = None

if 'df_clean' not in st.session_state: st.session_state.df_clean = None

if 'data_dict' not in st.session_state: st.session_state.data_dict = {}

if 'report_sections' not in st.session_state: st.session_state.report_sections = 

if 'audit_log' not in st.session_state: st.session_state.audit_log = 

# ==========================================

# UTILITY FUNCTIONS

# ==========================================

def log_action(action):

Â  Â  """Log user actions for audit trail."""

Â  Â  timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

Â  Â  st.session_state.audit_log.append(f"

$${timestamp}$$

 {action}")

def load_data(file):

Â  Â  """Universal data loader."""

Â  Â  try:

Â  Â  Â  Â  ext = file.name.split('.')

$$-1$$

.lower()

Â  Â  Â  Â  if ext == 'csv': return pd.read_csv(file)

Â  Â  Â  Â  elif ext in 

$$'xls', 'xlsx'$$

: return pd.read_excel(file)

Â  Â  Â  Â  elif ext == 'dta': return pd.read_stata(file)

Â  Â  Â  Â  elif ext == 'sav': return pd.read_spss(file)

Â  Â  Â  Â  else: return pd.read_table(file)

Â  Â  except Exception as e:

Â  Â  Â  Â  st.error(f"Error loading file: {e}")

Â  Â  Â  Â  return None

def detect_variable_types(df):

Â  Â  """Heuristic to detect variable types."""

Â  Â  types = {}

Â  Â  for col in df.columns:

Â  Â  Â  Â  if pd.api.types.is_numeric_dtype(df

$$col$$

):

Â  Â  Â  Â  Â  Â  if df

$$col$$

.nunique() < 10: types

$$col$$

 = "Categorical (Ordinal/Binary)"

Â  Â  Â  Â  Â  Â  else: types

$$col$$

 = "Continuous"

Â  Â  Â  Â  elif pd.api.types.is_datetime64_any_dtype(df

$$col$$

):

Â  Â  Â  Â  Â  Â  types

$$col$$

 = "Date/Time"

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  types

$$col$$

 = "Categorical (Nominal)"

Â  Â  return types

def add_to_report(title, content_type, content):

Â  Â  """Helper to add items to the report buffer."""

Â  Â  st.session_state.report_sections.append({

Â  Â  Â  Â  "title": title,

Â  Â  Â  Â  "type": content_type,

Â  Â  Â  Â  "content": content

Â  Â  })

Â  Â  st.toast(f"Added '{title}' to Report", icon="âœ…")

# --- DOCX GENERATOR ---

def generate_docx_report(title, author, sections):

Â  Â  doc = Document()

Â  Â  title_para = doc.add_heading(title, 0)

Â  Â  title_para.alignment = WD_ALIGN_PARAGRAPH.CENTER

Â  Â  meta = doc.add_paragraph(f"Author: {author}\nGenerated: {datetime.now().strftime('%Y-%m-%d')}")

Â  Â  meta.alignment = WD_ALIGN_PARAGRAPH.CENTER

Â  Â  doc.add_page_break()

Â  Â  for section in sections:

Â  Â  Â  Â  doc.add_heading(section

$$'title'$$

, level=1)

Â  Â  Â  Â  if section

$$'type'$$

 == 'text':

Â  Â  Â  Â  Â  Â  doc.add_paragraph(section

$$'content'$$

)

Â  Â  Â  Â  elif section

$$'type'$$

 == 'table':

Â  Â  Â  Â  Â  Â  df = section

$$'content'$$

Â  Â  Â  Â  Â  Â  t = doc.add_table(df.shape

$$0$$

+1, df.shape

$$1$$

)

Â  Â  Â  Â  Â  Â  t.style = 'Table Grid'

Â  Â  Â  Â  Â  Â  for j in range(df.shape

$$-1$$

): t.cell(0, j).text = str(df.columns

$$j$$

)

Â  Â  Â  Â  Â  Â  for i in range(df.shape

$$0$$

):

Â  Â  Â  Â  Â  Â  Â  Â  for j in range(df.shape

$$-1$$

): t.cell(i+1, j).text = str(df.values

$$i, j$$

)

Â  Â  Â  Â  Â  Â  doc.add_paragraph("")

Â  Â  Â  Â  elif section

$$'type'$$

 == 'plot':

Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  img_bytes = section

$$'content'$$

.to_image(format="png", engine="kaleido", scale=2)

Â  Â  Â  Â  Â  Â  Â  Â  image_stream = io.BytesIO(img_bytes)

Â  Â  Â  Â  Â  Â  Â  Â  doc.add_picture(image_stream, width=Inches(6))

Â  Â  Â  Â  Â  Â  except Exception as e:

Â  Â  Â  Â  Â  Â  Â  Â  doc.add_paragraph(f"

$$Error: {str(e)}$$

")

Â  Â  buffer = io.BytesIO()

Â  Â  doc.save(buffer)

Â  Â  buffer.seek(0)

Â  Â  return buffer

# --- PDF GENERATOR (NEW) ---

class PDF(FPDF):

Â  Â  def header(self):

Â  Â  Â  Â  self.set_font('Arial', 'B', 15)

Â  Â  Â  Â  self.cell(0, 10, APP_NAME + ' Report', 0, 1, 'C')

Â  Â  Â  Â  self.ln(5)

Â  Â  def footer(self):

Â  Â  Â  Â  self.set_y(-15)

Â  Â  Â  Â  self.set_font('Arial', 'I', 8)

Â  Â  Â  Â  self.cell(0, 10, f'Page {self.page_no()}', 0, 0, 'C')

def generate_pdf_report(title, author, sections):

Â  Â  pdf = PDF()

Â  Â  pdf.add_page()

Â  Â  pdf.set_auto_page_break(auto=True, margin=15)

Â  Â  # Title Page

Â  Â  pdf.set_font("Arial", "B", 24)

Â  Â  pdf.cell(0, 40, title, 0, 1, "C")

Â  Â  pdf.set_font("Arial", "", 12)

Â  Â  pdf.cell(0, 10, f"Author: {author}", 0, 1, "C")

Â  Â  pdf.cell(0, 10, f"Date: {datetime.now().strftime('%Y-%m-%d')}", 0, 1, "C")

Â  Â  pdf.add_page()

Â  Â  for section in sections:

Â  Â  Â  Â  pdf.set_font("Arial", "B", 16)

Â  Â  Â  Â  pdf.cell(0, 10, section

$$'title'$$

, 0, 1)

Â  Â  Â  Â  pdf.ln(5)

Â  Â  Â  Â  if section

$$'type'$$

 == 'text':

Â  Â  Â  Â  Â  Â  pdf.set_font("Arial", "", 11)

Â  Â  Â  Â  Â  Â  pdf.multi_cell(0, 6, section

$$'content'$$

)

Â  Â  Â  Â  Â  Â  pdf.ln(5)

Â  Â  Â  Â  elif section

$$'type'$$

 == 'table':

Â  Â  Â  Â  Â  Â  # Simple Table rendering

Â  Â  Â  Â  Â  Â  pdf.set_font("Arial", "B", 10)

Â  Â  Â  Â  Â  Â  df = section

$$'content'$$

Â  Â  Â  Â  Â  Â  cols = df.columns

Â  Â  Â  Â  Â  Â  # Simple Column width strategy

Â  Â  Â  Â  Â  Â  col_width = pdf.w / (len(cols) + 1)

Â  Â  Â  Â  Â  Â  # Header

Â  Â  Â  Â  Â  Â  for col in cols:

Â  Â  Â  Â  Â  Â  Â  Â  pdf.cell(col_width, 8, str(col)

$$:15$$

, 1)

Â  Â  Â  Â  Â  Â  pdf.ln()

Â  Â  Â  Â  Â  Â  # Rows

Â  Â  Â  Â  Â  Â  pdf.set_font("Arial", "", 9)

Â  Â  Â  Â  Â  Â  for i in range(len(df)):

Â  Â  Â  Â  Â  Â  Â  Â  for col in cols:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.cell(col_width, 8, str(df.iloc

$$i$$

$$col$$

)

$$:15$$

, 1)

Â  Â  Â  Â  Â  Â  Â  Â  pdf.ln()

Â  Â  Â  Â  Â  Â  pdf.ln(10)

Â  Â  Â  Â  elif section

$$'type'$$

 == 'plot':

Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  # Save plot as temp image

Â  Â  Â  Â  Â  Â  Â  Â  with tempfile.NamedTemporaryFile(suffix=".png", delete=False) as tmpfile:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  section

$$'content'$$

.write_image(tmpfile.name, engine="kaleido", scale=2)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.image(tmpfile.name, w=170)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.ln(5)

Â  Â  Â  Â  Â  Â  Â  Â  # Cleanup handled by OS mostly, but good practice to delete if possible

Â  Â  Â  Â  Â  Â  Â  Â  try: os.remove(tmpfile.name)

Â  Â  Â  Â  Â  Â  Â  Â  except: pass

Â  Â  Â  Â  Â  Â  except Exception as e:

Â  Â  Â  Â  Â  Â  Â  Â  pdf.set_font("Arial", "I", 10)

Â  Â  Â  Â  Â  Â  Â  Â  pdf.cell(0, 10, f"Error rendering chart: {e}", 0, 1)

Â  Â  return pdf.output(dest='S').encode('latin-1', 'replace')

# ==========================================

# SIDEBAR

# ==========================================

st.sidebar.title(f"âš•ï¸ {APP_NAME}")

st.sidebar.caption(f"v{VERSION} | Dev: Raja Mashood Elahi")

step = st.sidebar.radio("Workflow", [

Â  Â  "1. Upload & Setup",

Â  Â  "2. Data Cleaning",

Â  Â  "3. Table 1 (Baseline)",

Â  Â  "4. Exploratory Viz",

Â  Â  "5. Statistical Tests",

Â  Â  "6. Regression Models",

Â  Â  "7. Diagnostic Evaluation",

Â  Â  "8. Survival Analysis",

Â  Â  "9. Sample Size (Power)",

Â  Â  "10. Report Download"

])

st.sidebar.markdown("---")

st.sidebar.info("ğŸ’¡ **New:** Native PDF export is now available!")

# ==========================================

# 1. UPLOAD & SETUP

# ==========================================

if step == "1. Upload & Setup":

Â  Â  st.title("Project Setup")

Â  Â  col1, col2 = st.columns(

$$1, 2$$

)

Â  Â  with col1:

Â  Â  Â  Â  st.markdown("### ğŸ“‚ Import Data")

Â  Â  Â  Â  uploaded_file = st.file_uploader("Drop CSV, Excel, SPSS, or Stata files", type=

$$'csv', 'xlsx', 'sav', 'dta'$$

)

Â  Â  Â  Â  if st.button("Load Demo Dataset (Heart Disease)"):

Â  Â  Â  Â  Â  Â  np.random.seed(42)

Â  Â  Â  Â  Â  Â  n = 300

Â  Â  Â  Â  Â  Â  data = {

Â  Â  Â  Â  Â  Â  Â  Â  'PatientID': range(1, n+1),

Â  Â  Â  Â  Â  Â  Â  Â  'Age': np.random.normal(60, 10, n).astype(int),

Â  Â  Â  Â  Â  Â  Â  Â  'Sex': np.random.choice(

$$'Male', 'Female'$$

, n),

Â  Â  Â  Â  Â  Â  Â  Â  'Cholesterol': np.random.normal(200, 40, n),

Â  Â  Â  Â  Â  Â  Â  Â  'BMI': np.random.normal(28, 5, n),

Â  Â  Â  Â  Â  Â  Â  Â  'Treatment': np.random.choice(

$$'Placebo', 'Statin', 'NewDrug'$$

, n),

Â  Â  Â  Â  Â  Â  Â  Â  'Outcome': np.random.choice(

$$'Recovered', 'No Change'$$

, n, p=

$$0.6, 0.4$$

),

Â  Â  Â  Â  Â  Â  Â  Â  'Disease_Status': np.random.choice(

$$0, 1$$

, n),

Â  Â  Â  Â  Â  Â  Â  Â  'Test_Result': np.random.normal(0.5, 0.2, n) + (np.random.choice(

$$0, 1$$

, n) * 0.3),

Â  Â  Â  Â  Â  Â  Â  Â  'FollowUp_Days': np.random.exponential(365, n).astype(int),

Â  Â  Â  Â  Â  Â  Â  Â  'Event_Death': np.random.choice(

$$0, 1$$

, n, p=

$$0.8, 0.2$$

)

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  st.session_state.df = pd.DataFrame(data)

Â  Â  Â  Â  Â  Â  st.session_state.df_clean = st.session_state.df.copy()

Â  Â  Â  Â  Â  Â  st.success("Demo data loaded!")

Â  Â  with col2:

Â  Â  Â  Â  if st.session_state.df is not None:

Â  Â  Â  Â  Â  Â  st.markdown("### ğŸ” Data Preview")

Â  Â  Â  Â  Â  Â  st.dataframe(st.session_state.df.head(8), use_container_width=True)

Â  Â  Â  Â  Â  Â  st.markdown("### ğŸ·ï¸ Variable Types")

Â  Â  Â  Â  Â  Â  df = st.session_state.df

Â  Â  Â  Â  Â  Â  detected = detect_variable_types(df)

Â  Â  Â  Â  Â  Â  with st.expander("Edit Data Dictionary", expanded=True):

Â  Â  Â  Â  Â  Â  Â  Â  new_types = {}

Â  Â  Â  Â  Â  Â  Â  Â  for col in df.columns:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c1, c2 = st.columns(

$$1, 2$$

)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c1.text(col)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  options = 

$$"Continuous", "Categorical (Nominal)", "Categorical (Ordinal/Binary)", "Date/Time", "ID/Text"$$

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default_type = detected.get(col, "Categorical (Nominal)")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if default_type not in options: default_type = "Categorical (Nominal)"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new_types

$$col$$

 = c2.selectbox(f"Type: {col}", options, index=options.index(default_type), label_visibility="collapsed")

Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.data_dict = new_types

# ==========================================

# 2. DATA CLEANING

# ==========================================

elif step == "2. Data Cleaning":

Â  Â  st.title("Data Cleaning Studio")

Â  Â  df = st.session_state.df_clean

Â  Â  if df is None: st.warning("Upload data first."); st.stop()

Â  Â  t1, t2, t3 = st.tabs(

$$"Missing Data", "Recode/Filter", "Outliers"$$

)

Â  Â  with t1:

Â  Â  Â  Â  st.subheader("Imputation")

Â  Â  Â  Â  miss_cols = df.columns

$$df.isnull().any()$$

.tolist()

Â  Â  Â  Â  if miss_cols:

Â  Â  Â  Â  Â  Â  c1, c2 = st.columns(2)

Â  Â  Â  Â  Â  Â  target = c1.selectbox("Target Column", miss_cols)

Â  Â  Â  Â  Â  Â  method = c2.selectbox("Method", 

$$"Mean", "Median", "Mode", "Drop Rows"$$

)

Â  Â  Â  Â  Â  Â  if st.button("Apply Imputation"):

Â  Â  Â  Â  Â  Â  Â  Â  if method == "Drop Rows":

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.df_clean = df.dropna(subset=

$$target$$

)

Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strategy = 'mean' if method == "Mean" else 'median' if method == "Median" else 'most_frequent'

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imp = SimpleImputer(strategy=strategy)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.df_clean

$$\[target$$

] = imp.fit_transform(df

$$\[target$$

])

Â  Â  Â  Â  Â  Â  Â  Â  st.rerun()

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  st.success("No missing values found.")

Â  Â  with t2:

Â  Â  Â  Â  st.subheader("Filter Rows")

Â  Â  Â  Â  f_col = st.selectbox("Filter by", df.columns)

Â  Â  Â  Â  f_val = st.text_input(f"Keep rows where {f_col} equals (or > for numbers):")

Â  Â  Â  Â  if st.button("Apply Filter"):

Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  if pd.api.types.is_numeric_dtype(df

$$f_col$$

):

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.df_clean = df

$$df\[f_col$$

 >= float(f_val)]

Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.df_clean = df

$$df\[f_col$$

.astype(str) == f_val]

Â  Â  Â  Â  Â  Â  Â  Â  st.success(f"Filtered. Rows remaining: {len(st.session_state.df_clean)}")

Â  Â  Â  Â  Â  Â  except:

Â  Â  Â  Â  Â  Â  Â  Â  st.error("Filter failed. Check your input.")

Â  Â  with t3:

Â  Â  Â  Â  st.subheader("Outlier Removal (IQR)")

Â  Â  Â  Â  num_cols = df.select_dtypes(include=np.number).columns

Â  Â  Â  Â  target_out = st.selectbox("Check Outliers", num_cols)

Â  Â  Â  Â  if st.button("Remove Outliers"):

Â  Â  Â  Â  Â  Â  Q1 = df

$$target_out$$

.quantile(0.25)

Â  Â  Â  Â  Â  Â  Q3 = df

$$target_out$$

.quantile(0.75)

Â  Â  Â  Â  Â  Â  IQR = Q3 - Q1

Â  Â  Â  Â  Â  Â  filter_mask = ~((df

$$target_out$$

 < (Q1 - 1.5 * IQR)) | (df

$$target_out$$

 > (Q3 + 1.5 * IQR)))

Â  Â  Â  Â  Â  Â  st.session_state.df_clean = df

$$filter_mask$$

Â  Â  Â  Â  Â  Â  st.success(f"Removed {len(df) - len(st.session_state.df_clean)} outliers.")

# ==========================================

# 3. TABLE 1

# ==========================================

elif step == "3. Table 1 (Baseline)":

Â  Â  st.title("Baseline Characteristics (Table 1)")

Â  Â  df = st.session_state.df_clean

Â  Â  col_strat = st.selectbox("Stratify by (Group)", 

$$"None"$$

 + list(df.columns))

Â  Â  cols_inc = st.multiselect("Variables", df.columns, default=list(df.columns)

$$:5$$

)

Â  Â  if st.button("Generate Table"):

Â  Â  Â  Â  data = 

Â  Â  Â  Â  for col in cols_inc:

Â  Â  Â  Â  Â  Â  if col == col_strat: continue

Â  Â  Â  Â  Â  Â  is_numeric = pd.api.types.is_numeric_dtype(df

$$col$$

) and df

$$col$$

.nunique() > 5

Â  Â  Â  Â  Â  Â  row = {"Characteristic": col}

Â  Â  Â  Â  Â  Â  if col_strat != "None":

Â  Â  Â  Â  Â  Â  Â  Â  groups = sorted(df

$$col_strat$$

.dropna().unique())

Â  Â  Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  group_arrays = 

$$df\[df\[col_strat$$

 == g]

$$col$$

.dropna() for g in groups]

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if is_numeric:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if len(groups) == 2: _, p = stats.ttest_ind(*group_arrays)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else: _, p = stats.f_oneway(*group_arrays)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row

$$"P-Value"$$

 = f"{p:.3f}"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contingency = pd.crosstab(df

$$col$$

, df

$$col_strat$$

)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  _, p, _, _ = stats.chi2_contingency(contingency)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row

$$"P-Value"$$

 = f"{p:.3f}"

Â  Â  Â  Â  Â  Â  Â  Â  except: row

$$"P-Value"$$

 = "-"

Â  Â  Â  Â  Â  Â  Â  Â  for g in groups:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sub = df

$$df\[col_strat$$

 == g]

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if is_numeric: row

$$str(g)$$

 = f"{sub

$$col$$

.mean():.1f} Â± {sub

$$col$$

.std():.1f}"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  top = sub

$$col$$

.mode()

$$0$$

 if not sub

$$col$$

.empty else "N/A"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count = sub

$$col$$

.value_counts().max()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pct = (count/len(sub))*100

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row

$$str(g)$$

 = f"{count} ({pct:.1f}%)"

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  if is_numeric: row

$$"Total"$$

 = f"{df

$$col$$

.mean():.1f} Â± {df

$$col$$

.std():.1f}"

Â  Â  Â  Â  Â  Â  Â  Â  else: row

$$"Total"$$

 = f"n={len(df)}"

Â  Â  Â  Â  Â  Â  data.append(row)

Â  Â  Â  Â  res_df = pd.DataFrame(data)

Â  Â  Â  Â  st.dataframe(res_df, use_container_width=True)

Â  Â  Â  Â  add_to_report("Table 1: Baseline Characteristics", "table", res_df)

# ==========================================

# 4. EXPLORATORY VIZ

# ==========================================

elif step == "4. Exploratory Viz":

Â  Â  st.title("Exploratory Data Analysis")

Â  Â  df = st.session_state.df_clean

Â  Â  viz_type = st.selectbox("Chart Type", 

$$"Scatter Plot", "Box Plot", "Violin Plot", "Histogram", "Bar Chart", "Heatmap"$$

)

Â  Â  c1, c2, c3 = st.columns(3)

Â  Â  x_var = c1.selectbox("X Axis", df.columns)

Â  Â  y_var = c2.selectbox("Y Axis (Optional)", 

$$"None"$$

 + list(df.columns))

Â  Â  color_var = c3.selectbox("Color By", 

$$"None"$$

 + list(df.columns))

Â  Â  fig = None

Â  Â  y = None if y_var == "None" else y_var

Â  Â  color = None if color_var == "None" else color_var

Â  Â  if viz_type == "Scatter Plot" and y: fig = px.scatter(df, x=x_var, y=y, color=color, trendline="ols", template="plotly_white")

Â  Â  elif viz_type == "Box Plot": fig = px.box(df, x=x_var, y=y, color=color, template="plotly_white")

Â  Â  elif viz_type == "Violin Plot": fig = px.violin(df, x=x_var, y=y, color=color, box=True, template="plotly_white")

Â  Â  elif viz_type == "Histogram": fig = px.histogram(df, x=x_var, color=color, marginal="box", template="plotly_white")

Â  Â  elif viz_type == "Bar Chart": fig = px.bar(df, x=x_var, y=y, color=color, template="plotly_white")

Â  Â  elif viz_type == "Heatmap":

Â  Â  Â  Â  numeric_df = df.select_dtypes(include=np.number)

Â  Â  Â  Â  fig = px.imshow(numeric_df.corr(), text_auto=True, template="plotly_white", aspect="auto")

Â  Â  if fig:

Â  Â  Â  Â  st.plotly_chart(fig, use_container_width=True)

Â  Â  Â  Â  if st.button("Add Plot to Report"): add_to_report(f"{viz_type}: {x_var} vs {y_var}", "plot", fig)

# ==========================================

# 5. STATISTICAL TESTS

# ==========================================

elif step == "5. Statistical Tests":

Â  Â  st.title("Smart Statistical Engine")

Â  Â  df = st.session_state.df_clean

Â  Â  c1, c2 = st.columns(2)

Â  Â  v1 = c1.selectbox("Variable A (Outcome)", df.columns)

Â  Â  v2 = c2.selectbox("Variable B (Group)", df.columns)

Â  Â  if st.button("Run Auto-Test"):

Â  Â  Â  Â  is_num_1 = pd.api.types.is_numeric_dtype(df

$$v1$$

)

Â  Â  Â  Â  is_num_2 = pd.api.types.is_numeric_dtype(df

$$v2$$

)

Â  Â  Â  Â  if is_num_1 and not is_num_2:

Â  Â  Â  Â  Â  Â  groups = df

$$v2$$

.unique()

Â  Â  Â  Â  Â  Â  group_data = 

$$df\[df\[v2$$

==g]

$$v1$$

.dropna() for g in groups]

Â  Â  Â  Â  Â  Â  normality_p = stats.shapiro(df

$$v1$$

.dropna().sample(min(50, len(df))))

$$1$$

Â  Â  Â  Â  Â  Â  try: levene_p = stats.levene(*group_data)

$$1$$

Â  Â  Â  Â  Â  Â  except: levene_p = 1.0

Â  Â  Â  Â  Â  Â  st.write(f"Normality p={normality_p:.3f} | Homogeneity p={levene_p:.3f}")

Â  Â  Â  Â  Â  Â  if len(groups) == 2:

Â  Â  Â  Â  Â  Â  Â  Â  if normality_p > 0.05:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  test_name = "Student's T-Test"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stat, p = stats.ttest_ind(*group_data)

Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  test_name = "Mann-Whitney U"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stat, p = stats.mannwhitneyu(*group_data)

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  if normality_p > 0.05:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  test_name = "One-Way ANOVA"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stat, p = stats.f_oneway(*group_data)

Â  Â  Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  test_name = "Kruskal-Wallis"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stat, p = stats.kruskal(*group_data)

Â  Â  Â  Â  Â  Â  st.metric(f"{test_name} P-Value", f"{p:.4f}")

Â  Â  Â  Â  Â  Â  if p < 0.05 and "ANOVA" in test_name:

Â  Â  Â  Â  Â  Â  Â  Â  st.text(pairwise_tukeyhsd(endog=df

$$v1$$

.dropna(), groups=df

$$v2$$

.dropna()))

Â  Â  Â  Â  Â  Â  fig = px.box(df, x=v2, y=v1, title=test_name)

Â  Â  Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  Â  Â  add_to_report(f"Comparison: {v1} by {v2}", "plot", fig)

Â  Â  Â  Â  elif not is_num_1 and not is_num_2:

Â  Â  Â  Â  Â  Â  ct = pd.crosstab(df

$$v1$$

, df

$$v2$$

)

Â  Â  Â  Â  Â  Â  chi2, p, dof, expected = stats.chi2_contingency(ct)

Â  Â  Â  Â  Â  Â  st.metric("Chi-Square P-Value", f"{p:.4f}")

Â  Â  Â  Â  Â  Â  fig = px.imshow(ct, text_auto=True)

Â  Â  Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  Â  Â  add_to_report(f"Chi-Square: {v1} vs {v2}", "plot", fig)

Â  Â  Â  Â  elif is_num_1 and is_num_2:

Â  Â  Â  Â  Â  Â  r, p = stats.pearsonr(df

$$v1$$

.dropna(), df

$$v2$$

.dropna())

Â  Â  Â  Â  Â  Â  st.metric(f"Pearson r", f"{r:.3f}")

Â  Â  Â  Â  Â  Â  fig = px.scatter(df, x=v1, y=v2, trendline="ols")

Â  Â  Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  Â  Â  add_to_report(f"Correlation: {v1} vs {v2}", "plot", fig)

# ==========================================

# 6. REGRESSION

# ==========================================

elif step == "6. Regression Models":

Â  Â  st.title("Regression Modeling")

Â  Â  df = st.session_state.df_clean

Â  Â  model_type = st.selectbox("Model", 

$$"Linear (OLS)", "Logistic (Binary)"$$

)

Â  Â  target = st.selectbox("Outcome (Y)", df.columns)

Â  Â  preds = st.multiselect("Predictors (X)", 

$$c for c in df.columns if c != target$$

)

Â  Â  if st.button("Fit Model") and preds:

Â  Â  Â  Â  formula = f"{target} ~ {' + '.join(preds)}"

Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  if model_type == "Linear (OLS)": model = smf.ols(formula, data=df).fit()

Â  Â  Â  Â  Â  Â  else: model = smf.logit(formula, data=df).fit()

Â  Â  Â  Â  Â  Â  st.text(model.summary().as_text())

Â  Â  Â  Â  Â  Â  res_df = pd.DataFrame({"Coef": model.params, "Lower": model.conf_int()

$$0$$

, "Upper": model.conf_int()

$$1$$

})

Â  Â  Â  Â  Â  Â  if "Logistic" in model_type: res_df = np.exp(res_df)

Â  Â  Â  Â  Â  Â  fig = go.Figure()

Â  Â  Â  Â  Â  Â  fig.add_trace(go.Scatter(x=res_df

$$'Coef'$$

, y=res_df.index, error_x=dict(type='data', array=res_df

$$'Upper'$$

-res_df

$$'Coef'$$

, arrayminus=res_df

$$'Coef'$$

-res_df

$$'Lower'$$

), mode='markers', marker=dict(color='black')))

Â  Â  Â  Â  Â  Â  fig.update_layout(title="Forest Plot")

Â  Â  Â  Â  Â  Â  fig.add_vline(x=1 if "Logistic" in model_type else 0, line_dash="dash", line_color="red")

Â  Â  Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  Â  Â  add_to_report(f"Regression ({model_type})", "plot", fig)

Â  Â  Â  Â  except Exception as e: st.error(f"Error: {e}")

# ==========================================

# 7. DIAGNOSTIC EVALUATION

# ==========================================

elif step == "7. Diagnostic Evaluation":

Â  Â  st.title("Diagnostic Test Evaluation")

Â  Â  df = st.session_state.df_clean

Â  Â  c1, c2 = st.columns(2)

Â  Â  gold = c1.selectbox("Gold Standard (Binary)", df.columns)

Â  Â  test_var = c2.selectbox("Test Variable", df.columns)

Â  Â  if st.button("Run Analysis"):

Â  Â  Â  Â  if df

$$gold$$

.nunique() != 2: st.error("Gold Standard must be binary.")

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  y_true, y_score = df

$$gold$$

, df

$$test_var$$

Â  Â  Â  Â  Â  Â  if pd.api.types.is_numeric_dtype(y_score) and y_score.nunique() > 2:

Â  Â  Â  Â  Â  Â  Â  Â  fpr, tpr, thresh = roc_curve(y_true, y_score, pos_label=1)

Â  Â  Â  Â  Â  Â  Â  Â  fig = px.area(x=fpr, y=tpr, title=f'ROC Curve (AUC={auc(fpr, tpr):.2f})', labels=dict(x='1-Specificity', y='Sensitivity'))

Â  Â  Â  Â  Â  Â  Â  Â  fig.add_shape(type='line', line=dict(dash='dash'), x0=0, x1=1, y0=0, y1=1)

Â  Â  Â  Â  Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  Â  Â  Â  Â  add_to_report(f"ROC Curve: {test_var}", "plot", fig)

Â  Â  Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  Â  Â  cm = confusion_matrix(y_true, y_score)

Â  Â  Â  Â  Â  Â  Â  Â  tn, fp, fn, tp = cm.ravel()

Â  Â  Â  Â  Â  Â  Â  Â  st.metric("Sensitivity", f"{tp/(tp+fn):.2%}")

Â  Â  Â  Â  Â  Â  Â  Â  fig_cm = ff.create_annotated_heatmap(

$$\[tn, fp$$

, 

$$fn, tp$$

], x=

$$'Neg', 'Pos'$$

, y=

$$'No Disease', 'Disease'$$

, colorscale='Blues')

Â  Â  Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_cm)

Â  Â  Â  Â  Â  Â  Â  Â  add_to_report(f"Confusion Matrix: {test_var}", "plot", fig_cm)

# ==========================================

# 8. SURVIVAL

# ==========================================

elif step == "8. Survival Analysis":

Â  Â  st.title("Survival Analysis")

Â  Â  df = st.session_state.df_clean

Â  Â  c1, c2, c3 = st.columns(3)

Â  Â  time_col, event_col, group_col = c1.selectbox("Time", df.columns), c2.selectbox("Event (0/1)", df.columns), c3.selectbox("Group", 

$$"None"$$

 + list(df.columns))

Â  Â  if st.button("Plot Survival"):

Â  Â  Â  Â  kmf = KaplanMeierFitter()

Â  Â  Â  Â  fig = go.Figure()

Â  Â  Â  Â  if group_col == "None":

Â  Â  Â  Â  Â  Â  kmf.fit(df

$$time_col$$

, df

$$event_col$$

, label="Overall")

Â  Â  Â  Â  Â  Â  fig.add_trace(go.Scatter(x=kmf.timeline, y=kmf.survival_function_.iloc

$$:,0$$

, mode='lines', name="Overall"))

Â  Â  Â  Â  else:

Â  Â  Â  Â  Â  Â  for name, grouped_df in df.groupby(group_col):

Â  Â  Â  Â  Â  Â  Â  Â  kmf.fit(grouped_df

$$time_col$$

, grouped_df

$$event_col$$

, label=str(name))

Â  Â  Â  Â  Â  Â  Â  Â  fig.add_trace(go.Scatter(x=kmf.timeline, y=kmf.survival_function_.iloc

$$:,0$$

, mode='lines', name=str(name)))

Â  Â  Â  Â  fig.update_layout(title="Kaplan-Meier Curve", xaxis_title="Time", yaxis_title="Survival Probability")

Â  Â  Â  Â  st.plotly_chart(fig)

Â  Â  Â  Â  add_to_report("Kaplan-Meier Curve", "plot", fig)

# ==========================================

# 9. SAMPLE SIZE

# ==========================================

elif step == "9. Sample Size (Power)":

Â  Â  st.title("Sample Size Calculator")

Â  Â  c1, c2, c3 = st.columns(3)

Â  Â  d = c1.number_input("Cohen's d", 0.2, 2.0, 0.5)

Â  Â  p = c2.number_input("Power", 0.5, 0.99, 0.8)

Â  Â  a = c3.number_input("Alpha", 0.01, 0.1, 0.05)

Â  Â  if st.button("Calculate"):

Â  Â  Â  Â  n = TTestIndPower().solve_power(effect_size=d, power=p, alpha=a)

Â  Â  Â  Â  st.metric("Required N (Per Group)", f"{int(np.ceil(n))}")

# ==========================================

# 10. REPORT DOWNLOAD

# ==========================================

elif step == "10. Report Download":

Â  Â  st.title("ğŸ“„ Generate Final Report")

Â  Â  st.write(f"**Items in Report:** {len(st.session_state.report_sections)}")

Â  Â  c1, c2 = st.columns(2)

Â  Â  title = c1.text_input("Title", "Analysis Report")

Â  Â  author = c2.text_input("Author", "Investigator")

Â  Â  col_html, col_docx, col_pdf = st.columns(3)

Â  Â  with col_html:

Â  Â  Â  Â  if st.button("Download HTML"):

Â  Â  Â  Â  Â  Â  html = f"{title}"

Â  Â  Â  Â  Â  Â  for s in st.session_state.report_sections:

Â  Â  Â  Â  Â  Â  Â  Â  html += f"{s

$$'title'$$

}"

Â  Â  Â  Â  Â  Â  Â  Â  if s

$$'type'$$

 == 'plot': html += s

$$'content'$$

.to_html(full_html=False, include_plotlyjs='cdn')

Â  Â  Â  Â  Â  Â  Â  Â  elif s

$$'type'$$

 == 'table': html += s

$$'content'$$

.to_html()

Â  Â  Â  Â  Â  Â  Â  Â  elif s

$$'type'$$

 == 'text': html += f"{s

$$'content'$$

}"

Â  Â  Â  Â  Â  Â  b64 = base64.b64encode(html.encode()).decode()

Â  Â  Â  Â  Â  Â  st.markdown(f'ğŸ“¥ Download HTML', unsafe_allow_html=True)

Â  Â  with col_docx:

Â  Â  Â  Â  if st.button("Download DOCX"):

Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  docx = generate_docx_report(title, author, st.session_state.report_sections)

Â  Â  Â  Â  Â  Â  Â  Â  st.download_button("ğŸ“¥ Download DOCX", docx, "report.docx", "application/vnd.openxmlformats-officedocument.wordprocessingml.document")

Â  Â  Â  Â  Â  Â  except Exception as e: st.error(f"Error: {e}")

Â  Â  with col_pdf:

Â  Â  Â  Â  if st.button("Download PDF"):

Â  Â  Â  Â  Â  Â  try:

Â  Â  Â  Â  Â  Â  Â  Â  pdf_bytes = generate_pdf_report(title, author, st.session_state.report_sections)

Â  Â  Â  Â  Â  Â  Â  Â  st.download_button("ğŸ“¥ Download PDF", pdf_bytes, "report.pdf", "application/pdf")

Â  Â  Â  Â  Â  Â  except Exception as e: st.error(f"Error: {e}")

st.markdown('?', unsafe_allow_html=True)
